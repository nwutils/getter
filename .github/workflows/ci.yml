name: ci

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    strategy:
      matrix:
        os:
          - macos-15
          - ubuntu-24.04
          - windows-2025
      fail-fast: false

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      - name: Setup Volta
        uses: volta-cli/action@v4.2.1

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        id: run_tests
        shell: bash
        run: |
          set -o pipefail
          node --experimental-test-coverage --test ./tests/specs/request.test.js 2>&1 | tee raw_test_output.txt

      - name: Clean ANSI colors
        shell: bash
        run: |
          sed -r "s/\x1B\[[0-9;]*[mK]//g" raw_test_output.txt > test_output.txt

            - name: Parse coverage section and convert to markdown table
        id: parse
        shell: bash
        run: |
          # Extract coverage block
          awk '
            BEGIN { capture=0 }
            tolower($0) ~ /start of coverage report/ { capture=1; next }
            tolower($0) ~ /end of coverage report/ { capture=0 }
            capture == 1 { print }
          ' test_output.txt > coverage_raw.txt

          # If nothing found, fallback
          if [ ! -s coverage_raw.txt ]; then
            echo "âš ï¸ No coverage found" > coverage_md.txt
            echo "COVERAGE<<EOF" >> $GITHUB_OUTPUT
            cat coverage_md.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Remove leading "i " chars and dashed dividers
          sed 's/^i //' coverage_raw.txt | \
          sed '/^-/d' > coverage_clean.txt

          # Convert ASCII lines into a clean markdown table
          {
            echo "| File | Line % | Branch % | Funcs % | Uncovered Lines |"
            echo "|------|--------|----------|---------|------------------|"

            # Extract rows that contain real coverage (those with %)
            grep '%' coverage_clean.txt | while read -r line; do
              file=$(echo "$line" | awk -F '|' '{print $1}' | xargs)
              linep=$(echo "$line" | awk -F '|' '{print $2}' | xargs)
              branchp=$(echo "$line" | awk -F '|' '{print $3}' | xargs)
              funcp=$(echo "$line" | awk -F '|' '{print $4}' | xargs)
              miss=$(echo "$line" | awk -F '|' '{print $5}' | xargs)

              echo "| $file | $linep | $branchp | $funcp | $miss |"
            done
          } > coverage_md.txt

          echo "COVERAGE<<EOF" >> $GITHUB_OUTPUT
          cat coverage_md.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update PR comment for OS
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          # Unique marker per OS ensures the comment is updated, not duplicated
          body-includes: "<!-- coverage-${{ matrix.os }} -->"
          edit-mode: replace
          body: |
            <!-- coverage-${{ matrix.os }} -->
            ## ðŸ§ª Test Coverage Report â€” **${{ matrix.os }}**
            ```
            ${{ steps.parse.outputs.COVERAGE }}
            ```
